WITH TMP1 AS
(SELECT I.OWNER INDEX_OWNER,
         I.TABLE_OWNER,
         TABLE_NAME,
         INDEX_NAME,
         INDEX_TYPE,
         (SELECT NB.CREATED
            FROM DBA_OBJECTS NB
           WHERE NB.OWNER = I.OWNER
             AND NB.OBJECT_NAME = I.INDEX_NAME
             AND NB.SUBOBJECT_NAME IS NULL
             AND NB.OBJECT_TYPE = 'INDEX') CREATED,
         (SUM(S.BYTES) / 1024 / 1024) INDEX_MB,
        (SELECT COUNT(1)
        FROM  DBA_IND_COLUMNS DIC
        WHERE  DIC.INDEX_NAME = I.INDEX_NAME
        AND    DIC.TABLE_NAME = I.TABLE_NAME
        AND    DIC.INDEX_OWNER = I.OWNER) COUNT_INDEX_COLS
    FROM DBA_SEGMENTS S, DBA_INDEXES I
   WHERE I.INDEX_NAME = S.SEGMENT_NAME
     AND I.OWNER = S.OWNER
     AND S.OWNER NOT LIKE '%SYS%'
   GROUP BY I.OWNER, I.TABLE_OWNER, TABLE_NAME, INDEX_NAME, INDEX_TYPE
  HAVING SUM(S.BYTES) > 1024 * 1024),
TMP2 AS
(SELECT INDEX_OWNER,
         INDEX_NAME,
         PLAN_OPERATION,
         (SELECT MIN(TO_CHAR(NB.BEGIN_INTERVAL_TIME, 'YYYY-MM-DD HH24:MI:SS'))
            FROM DBA_HIST_SNAPSHOT NB
           WHERE NB.SNAP_ID = V.MIN_SNAP_ID) MIN_DATE,
         (SELECT MAX(TO_CHAR(NB.END_INTERVAL_TIME, 'YYYY-MM-DD HH24:MI:SS'))
            FROM DBA_HIST_SNAPSHOT NB
           WHERE NB.SNAP_ID = V.MAX_SNAP_ID) MAX_DATE,
         COUNTS
    FROM (SELECT D.OBJECT_OWNER INDEX_OWNER,
                  D.OBJECT_NAME INDEX_NAME,
                  D.OPERATION || ' ' || D.OPTIONS PLAN_OPERATION,
                  MIN(H.SNAP_ID) MIN_SNAP_ID,
                  MAX(H.SNAP_ID) MAX_SNAP_ID,
                  COUNT(1) COUNTS
             FROM DBA_HIST_SQL_PLAN D, DBA_HIST_SQLSTAT H
            WHERE D.OPERATION LIKE '%INDEX%'
         AND D.SQL_ID = H.SQL_ID
            GROUP BY D.OBJECT_OWNER, D.OBJECT_NAME, D.OPERATION, D.OPTIONS) V)
SELECT A.TABLE_OWNER,
       A.TABLE_NAME,
       A.INDEX_OWNER,
       A.INDEX_NAME,
       A.CREATED,
       A.INDEX_TYPE,
       A.INDEX_MB,
             A.COUNT_INDEX_COLS,
       B.PLAN_OPERATION,
       CASE
         WHEN MIN_DATE IS NULL THEN
          (SELECT MIN(TO_CHAR(NB.BEGIN_INTERVAL_TIME, 'YYYY-MM-DD HH24:MI:SS'))
             FROM DBA_HIST_SNAPSHOT NB)
         ELSE
          MIN_DATE
       END AS  MIN_DATE,
       CASE
         WHEN MAX_DATE IS NULL THEN
          (SELECT MAX(TO_CHAR(NB.BEGIN_INTERVAL_TIME, 'YYYY-MM-DD HH24:MI:SS'))
             FROM DBA_HIST_SNAPSHOT NB)
         ELSE
          MAX_DATE
       END AS  MAX_DATE,
       COUNTS
  FROM TMP1 A
  LEFT OUTER JOIN TMP2 B
    ON (A.INDEX_OWNER = B.INDEX_OWNER AND A.INDEX_NAME = B.INDEX_NAME);
